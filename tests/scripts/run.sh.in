#!@BASH@
source $(dirname $0)/common.sh

function namewe () {
    local filename="$1"
    echo "$filename" | cut -f 1 -d '.'
}

# Source file that we are about to run tests on.
SAC_FILE=$1

# Location of the toplevel tests directory.
TOP_DIR=$2

# Cut the path off.
base_fname=$(basename $SAC_FILE)

# Cut the filename off.
dir_name=$(dirname $SAC_FILE)

# Generate the name for the extracted makefile.
makefile=${base_fname}.mk

base_fname_we=$(namewe "$base_fname")

# Generate the Makefile form a sac test:
@CMAKE_C_COMPILER@ -E -C -I$TOP_DIR -x c $SAC_FILE \
     | sed 's/[^[:print:]]//g' \
     | grep "^// SAC_TEST|" \
     | sed -e 's/^\/\/ SAC_TEST|//g'\
           -e "s/<tab>/$(printf '\t')/g" \
           -e "s/<file-name>/$base_fname/g" \
           -e "s/<file-name-we>/$base_fname_we/g" \
           -e 's/<nlslash>/\\/g' > ${dir_name}/$makefile

if test $? -ne 0; then
    die "cannot parse SAC_TEST specification in $SAC_FILE"
fi

if ! (cd ${dir_name}; make -I$TOP_DIR -f $makefile); then
    die "test $SAC_FILE failed"
fi

# else
#     echo "test $SAC_FILE passed"
# fi
