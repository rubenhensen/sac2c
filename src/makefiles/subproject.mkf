
#
# $Id$
#



###############################################################################
#
# Calling conventions:
#
#  Start rules: 
#    default    compile default code (subproject dependent)
#    devel      compile developer code 
#    prod       compile product code
#    efence     compile efence debugging code
#    clean      cleanup derived files
#    cleandevel cleanup compiled files (developer code only)
#    cleanprod  cleanup compiled files (product code only)
#
#  Parameters:
#    DEPS="no"  de-activate dependency checking meachanism
#    HIDE=""    show important commands issued by make (debugging)
#
###############################################################################


#######################################################################################
#
# general setup:
#

PROJECT_ROOT := ../..

HIDE   := @
DEPS   := yes

PREFIX_LOCAL := 
PREFIX_ROOT  := $(PROJECT_ROOT)/

include $(PROJECT_ROOT)/src/makefiles/config.mkf
include $(PROJECT_ROOT)/src/makefiles/targets.mkf

SUBPROJECT       := $(notdir $(CURDIR))
SUBPROJECT_DIRS  := $($(SUBPROJECT))

targetdirname    := $(targetdir_$(SUBPROJECT))
targetdir        := $(PROJECT_ROOT)/$(targetdirname)

targets_devel    := $(addprefix $(targetdir)/,$(targets_$(SUBPROJECT)_devel))
targets_prod     := $(addprefix $(targetdir)/,$(targets_$(SUBPROJECT)_prod))
targets_efence   := $(addprefix $(targetdir)/,$(targets_$(SUBPROJECT)_efence))
targets_default  := $(addprefix $(targetdir)/,$(targets_$(SUBPROJECT)_default))

clean_also       := $(addprefix $(targetdir)/,$(clean_$(SUBPROJECT)))
clean_also_devel := $(addprefix $(targetdir)/,$(clean_$(SUBPROJECT)_devel))
clean_also_prod  := $(addprefix $(targetdir)/,$(clean_$(SUBPROJECT)_prod))


###############################################################################
#
# Dummy rules
#

.PHONY: clean clean_dirs %.clean 
.PHONY: cleanprod cleanprod_dirs %.cleanprod 
.PHONY: cleandevel cleandevel_dirs %.cleandevel
.PHONY: default devel prod efence make_%


###############################################################################
#
# Start rules
#

default: make_default

devel: make_devel

prod: make_prod

efence: make_efence


###############################################################################
#
# Main rule
#

make_%: checks
	@$(ECHO) ""
	@$(ECHO) "************************************************************"
	@$(ECHO) "* Building $(PROJECT_NAME) $(SUBPROJECT) "
	@$(ECHO) "* revision $(REVISION)"
	@$(ECHO) "* on $(OS) for $(ARCH)"
	@$(ECHO) "************************************************************"
	@$(TOUCH) .make_track
	$(HIDE) $(MAKE) -f $(PROJECT_ROOT)/src/makefiles/core.mkf \
                         DEPS="$(DEPS)" HIDE="$(HIDE)" \
                         PREFIX_LOCAL="$(PREFIX_LOCAL)" \
                         PREFIX_ROOT="$(PREFIX_ROOT)" \
                         TARGETDIR="$(SUBPROJECT_DIRS)" \
                         TARGETS="$(targets_$*)" 
	@$(ECHO) ""





###############################################################################
#
# Rules for cleaning directories
#

clean: 
	@$(ECHO) ""
	@$(ECHO) "************************************************************"
	@$(ECHO) "* Cleaning $(PROJECT_NAME) $(SUBPROJECT)"
	@$(ECHO) "************************************************************"
	@$(ECHO) "Cleaning directory $(PREFIX_ROOT)$(targetdirname)"
	$(HIDE) $(RM) $(targets_devel) $(targets_prod) $(clean_also)
	@$(MAKE) HIDE="$(HIDE)" clean_dirs
	@$(ECHO) ""

clean_dirs: $(addsuffix .clean,$(SUBPROJECT_DIRS))

%.clean:
	@$(ECHO) "Cleaning directory $(PREFIX_LOCAL)$*"
	$(HIDE) $(MAKE) -C $* HIDE="$(HIDE)" clean_sourcedir


cleanprod: 
	@$(ECHO) ""
	@$(ECHO) "************************************************************"
	@$(ECHO) "* Cleaning $(PROJECT_NAME) $(SUBPROJECT)  (product code only)"
	@$(ECHO) "************************************************************"
	@$(ECHO) "Cleaning directory $(PREFIX_ROOT)$(targetdirname)"
	$(HIDE) $(RM) $(targets_prod) $(clean_also_prod)
	@$(MAKE) HIDE="$(HIDE)" cleanprod_dirs
	@$(ECHO) ""

cleanprod_dirs: $(addsuffix .cleanprod,$(SUBPROJECT_DIRS))

%.cleanprod:
	@$(ECHO) "Cleaning directory (PREFIX_LOCAL)$*"
	$(HIDE) $(MAKE) -C $* HIDE="$(HIDE)" cleanprod_sourcedir


cleandevel: 
	@$(ECHO) ""
	@$(ECHO) "************************************************************"
	@$(ECHO) "* Cleaning $(PROJECT_NAME) $(SUBPROJECT)  (developer code only)"
	@$(ECHO) "************************************************************"
	@$(ECHO) "Cleaning directory $(PREFIX_ROOT)$(targetdirname)"
	$(HIDE) $(RM) $(targets_devel) $(clean_also_devel)
	@$(MAKE) HIDE="$(HIDE)" cleandevel_dirs
	@$(ECHO) ""

cleandevel_dirs: $(addsuffix .cleandevel,$(SUBPROJECT_DIRS))

%.cleandevel:
	@$(ECHO) "Cleaning directory (PREFIX_LOCAL)$*"
	$(HIDE) $(MAKE) -C $* HIDE="$(HIDE)" cleandevel_sourcedir


###############################################################################
#
# Rules for consistency checks
#

include $(PROJECT_ROOT)/src/makefiles/check.mkf
