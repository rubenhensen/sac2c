# Create local variant of the SAC2C flags 
SET (SAC2C_T ${SAC2C_EXEC} -target ${TARGET})
SET (SAC2C ${SAC2C_T} -Xc "\"${SAC2C_EXTRA_INC}\"" -Xtc "\"${SAC2C_EXTRA_INC}\"")
SET (SAC2C_NT ${SAC2C} -Xc "\"${SAC2C_EXTRA_INC}\"" -Xtc "\"${SAC2C_EXTRA_INC}\"") # defaults to SEQ

EXECUTE_PROCESS (COMMAND ${SAC2C_T} -CTARGET_ENV OUTPUT_VARIABLE TARGET_ENV OUTPUT_STRIP_TRAILING_WHITESPACE)
IF (NOT TARGET_ENV)
    MESSAGE (FATAL_ERROR "${SAC2C_T} seems not to work, cannot determine SBI data, exiting...")
ELSE ()
    EXECUTE_PROCESS (COMMAND ${SAC2C_T} -CSBI OUTPUT_VARIABLE SBI OUTPUT_STRIP_TRAILING_WHITESPACE)
    EXECUTE_PROCESS (COMMAND ${SAC2C_T} -COBJEXT OUTPUT_VARIABLE OBJEXT OUTPUT_STRIP_TRAILING_WHITESPACE)
    EXECUTE_PROCESS (COMMAND ${SAC2C_T} -CTREE_DLLEXT OUTPUT_VARIABLE TREEEXT OUTPUT_STRIP_TRAILING_WHITESPACE)
    EXECUTE_PROCESS (COMMAND ${SAC2C_T} -CUSE_PHM_API OUTPUT_VARIABLE USE_PHM_API OUTPUT_STRIP_TRAILING_WHITESPACE)
    EXECUTE_PROCESS (COMMAND ${SAC2C_T} -CRTSPEC OUTPUT_VARIABLE RTSPEC OUTPUT_STRIP_TRAILING_WHITESPACE)
ENDIF ()

IF ("${SBI}" STREQUAL "XXXXX")
    MESSAGE (FATAL_ERROR "No SBI specification for target `${TARGET}', exiting...")
ENDIF ()
IF ("${TARGET_ENV}" STREQUAL "XXXXX")
    MESSAGE (FATAL_ERROR "No TARGET_ENV specificed for target `${TARGET}', exiting...")
ENDIF ()

MESSAGE (STATUS "Target `${TARGET}' build properties: ${TARGET_ENV} ${SBI} ${SHARED_LIB_EXT} ${OBJEXT} ${TREEEXT} ${USE_PHM_API} ${RTSPEC}")

# create directory
SET (PRELUDE_DIR "${DLL_BUILD_DIR}/prelude")
FILE (MAKE_DIRECTORY "${PRELUDE_DIR}/${TARGET_ENV}/${SBI}")
FILE (MAKE_DIRECTORY "${PRELUDE_DIR}/tree/${TARGET_ENV}")
SET (LIBSAC_MOD "${PRELUDE_DIR}/${TARGET_ENV}/${SBI}/libsacpreludeMod${SHARED_LIB_EXT}")
SET (LIBSAC_TREE "${PRELUDE_DIR}/tree/${TARGET_ENV}/libsacpreludeTree${SHARED_LIB_EXT}")

SET (LIBSAC_SRC
    "${CMAKE_CURRENT_SOURCE_DIR}/sacprelude.sac"
)

ADD_CUSTOM_COMMAND (
    OUTPUT "${LIBSAC_MOD}" "${LIBSAC_TREE}"
# FIXME: we currently pass some environment variables as is... is this compatible on other platforms?
COMMAND SAC2CRC=${SAC2CRC_BUILD_CONF} LD_LIBRARY_PATH=${LD_LIB_PATH} DYLD_LIBRARY_PATH=${DYLD_LIB_PATH} ${SAC2C} -v0 -linksetsize 0 -noprelude -o ${PRELUDE_DIR} ${LIBSAC_SRC} 
    DEPENDS ${LIBSAC_SRC}
    COMMENT "Generating libsacprelude for target `${TARGET}'")
ADD_CUSTOM_TARGET (libsacprelude-${TARGET} ALL DEPENDS "${LIBSAC_MOD}" "${LIBSAC_TREE}")
