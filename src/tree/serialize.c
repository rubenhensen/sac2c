/*
 * $Log$
 * Revision 1.3  2004/09/21 16:34:27  sah
 * ongoing implementation of
 * serialize traversal
 *
 * Revision 1.2  2004/09/21 09:49:34  sah
 * fixed missing ;
 *
 * Revision 1.1  2004/09/20 19:55:13  sah
 * Initial revision
 *
 *
 *
 */

#define NEW_INFO

#include "tree_basic.h"
#include "filemgr.h"
#include "stdio.h"
#include "serialize_info.h"
#include "serialize_stack.h"
#include "traverse.h"

/*
 * INFO functions
 */

static info *
MakeInfo ()
{
    info *result;

    DBUG_ENTER ("MakeInfo");

    result = Malloc (sizeof (info));

    INFO_SER_FILE (result) = NULL;
    INFO_SER_FILE (result) = NULL;

    DBUG_RETURN (result);
}

static info *
FreeInfo (info *info)
{
    DBUG_ENTER ("FreeInfo");

    info = Free (info);

    DBUG_RETURN (info);
}

static void
GenerateSerFileHead (info *info)
{
    DBUG_ENTER ("GenerateSerFileHead");

    fprintf (INFO_SER_FILE (info), "/* generated by sac2c %s */\n\n", &version_id);
    fprintf (INFO_SER_FILE (info), "#include \"serialize_helper.h\"\n\n");
    fprintf (INFO_SER_FILE (info), "#include \"serialize_stack.h\"\n\n");

    fprintf (INFO_SER_FILE (info), "#define PUSH( x) SerStackPush( x, stack)\n");
    fprintf (INFO_SER_FILE (info), "#define LOOKUP( x) SerStackLookup( x, stack)\n");

    DBUG_VOID_RETURN;
}

static void
GenerateSerFunBodyHead (node *fundef, info *info)
{
    DBUG_ENTER ("GenerateSerFunBodyHead");

    fprintf (INFO_SER_FILE (info), "node *__SBDY_%s_%s()", FUNDEF_MOD (fundef),
             FUNDEF_NAME (fundef));
    fprintf (INFO_SER_FILE (info), "{ serstack_t *stack = SerStackInit();\n");
    fprintf (INFO_SER_FILE (info), "node *result;\n");

    DBUG_VOID_RETURN;
}

static void
GenerateSerFunBodyTail (node *fundef, info *info)
{
    DBUG_ENTER ("GenerateSerFunBodyTail");

    fprintf (INFO_SER_FILE (info), "result = LOOKUP( %d);\n",
             SerStackFindPos (FUNDEF_BODY (fundef), INFO_SER_STACK (info)));

    fprintf (INFO_SER_FILE (info), "stack = SerStackDestroy( stack); }\n");

    DBUG_VOID_RETURN;
}

static void
SerializeFundefBody (node *fundef)
{
    char *filename;
    info *info;
    funtab *store_tab;

    DBUG_ENTER ("SerializeFundefBody");

    info = MakeInfo ();

    filename = TempFileName (tmp_dirname, "SER_", ".c");
    INFO_SER_FILE (info) = WriteOpen (filename);

    INFO_SER_STACK (info) = SerStackInit ();

    GenerateSerFileHead (info);
    GenerateSerFunBodyHead (fundef, info);

    store_tab = act_tab;
    act_tab = set_tab;

    FUNDEF_BODY (fundef) = Trav (FUNDEF_BODY (fundef), info);

    act_tab = store_tab;

    GenerateSerFunBodyTail (fundef, info);

    fclose (INFO_SER_FILE (info));
    Free (filename);

    INFO_SER_FILE (info) = NULL;

    INFO_SER_STACK (info) = SerStackDestroy (INFO_SER_STACK (info));

    info = FreeInfo (info);

    DBUG_VOID_RETURN;
}

void
SerializeModule (node *module)
{
    funtab *store_tab;

    DBUG_ENTER ("SerializeModule");

    DBUG_PRINT ("SER", ("Starting serialization run"));

    store_tab = act_tab;
    act_tab = ser_tab;

    Trav (module, NULL);

    act_tab = store_tab;

    DBUG_VOID_RETURN;
}

node *
SERFundef (node *arg_node, info *arg_info)
{
    DBUG_ENTER ("SERFundef");

    DBUG_PRINT ("SER", ("Serializing function %s", FUNDEF_NAME (arg_node)));

    SerializeFundefBody (arg_node);

    DBUG_RETURN (arg_node);
}
